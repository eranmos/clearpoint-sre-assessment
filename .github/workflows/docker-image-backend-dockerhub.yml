name: Backend-build-secure-and-push-dockerhub

on:
  push:
    branches: [ "main" ]
    paths:
     - Backend/**
     - .github/workflows/docker-image-backend-dockerhub.yml
  pull_request:
    branches: [ "main" ]
    paths:
     - Backend/**
     - .github/workflows/docker-image-backend-dockerhub.yml

env:
  BUILD_NUMBER: 1
  DOCKER_IMAGE_NAME: clearpoint_backend
  DOCKER_REGISTRY: erandocker

jobs:
  build-backend-docker-image:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: Build BE Docker image
      working-directory: Backend/TodoList.Api
      run: |
        docker build . --file Dockerfile --tag ${{env.DOCKER_REGISTRY}}/${{env.DOCKER_IMAGE_NAME}}:${{github.run_number}}
        docker tag ${{env.DOCKER_REGISTRY}}/${{env.DOCKER_IMAGE_NAME}}:${{github.run_number}} ${{env.DOCKER_REGISTRY}}/${{env.DOCKER_IMAGE_NAME}}:latest

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: '${{env.DOCKER_REGISTRY}}/${{env.DOCKER_IMAGE_NAME}}:${{github.run_number}}'
        format: 'table'
        exit-code: '0'
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'HIGH,CRITICAL'

    - name: Login to DockerHub
      run: docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }}

    - name: publish docker image to dockerhub
      run: |
       docker push ${{env.DOCKER_REGISTRY}}/${{env.DOCKER_IMAGE_NAME}}:${{github.run_number}}
       docker push ${{env.DOCKER_REGISTRY}}/${{env.DOCKER_IMAGE_NAME}}:latest
